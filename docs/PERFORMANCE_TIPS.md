# نصائح الأداء والبنية — Performance & Structure Tips

نصائح لتجعل التطبيق أخف وأسرع ومرتبًا.

---

## 1. تحميل البيانات (شعور سرعة محلية)

- **ذاكرة تخزين مؤقت للقوائم (API cache)**  
  الخطوط والباقات تُخزَّن في الذاكرة لمدة (مثلاً دقيقة). عند العودة للصفحة لا يتم جلب البيانات من السيرفر مرة أخرى فورًا، فيبدو التحميل فوريًا.  
  الملف: `src/lib/apiCache.js`

- **عدم إعادة الجلب بعد الإضافة/التعديل/الحذف**  
  بعد أي عملية نحدّث الواجهة من نتيجة الطلب فقط، بدون طلب `GET` إضافي للقائمة.

- **Optimistic updates (تحديث متفائل)**  
  في إضافة الخط: نعرض الخط في القائمة فورًا ثم نرسل الطلب للسيرفر. عند النجاح نستبدل السطر بالبيانات القادمة من السيرفر؛ عند الفشل نزيل السطر ونعرض رسالة خطأ.

---

## 2. استقرار الـ Gate وتقليل إعادة الجلب

- **Gate مستقر بالهوية (stable identity)**  
  في `DataContext` الـ gate يعتمد على `auth` فقط ويقرأ أحدث البيانات من `dataRef.current`. تغيّر `data` لا يغيّر هوية الـ gate، فلا تُشغَّل effects في الصفحات (مثل Lines/Packages) بسبب تغيّر الـ gate فقط.

- **تأثير التحميل في الصفحات**  
  في PackagesPage و LinesPage، الـ `useEffect` الذي يستدعي تحميل البيانات يعتمد على `[useLinesApi, token]` أو `[usePackagesApi, token]` فقط، وليس على `gate` أو `data`.

---

## 3. تقليل العمل في كل عملية

- **بنية البيانات**: القوائم مصفوفات؛ البحث بالـ id يتم بـ `find`/`filter`. إذا نمت القوائم كثيرًا يمكن لاحقًا استخدام `Map` keyed by id للوصول O(1) عند الحاجة.

- **تحديثات محلية**: عند التعديل نستبدل العنصر في المصفوفة بدل نسخ كائن ضخم؛ نحدّث الحقول المطلوبة فقط.

- **إبطال الكاش بعد الطفرات**: بعد إضافة/تعديل/حذف خط أو باقة نستدعي `invalidateLines()` أو `invalidatePackages()` حتى التحميل التالي يجلب بيانات حديثة.

---

## 4. التحميل الكسول والـ Bundle

- **Lazy routes**: أغلب الصفحات (المشتركين، الموزعين، الخطوط، الخريطة، الباقات، الأجهزة، الموظفين، المالية) محمّلة بـ `React.lazy()`. فقط الصفحة الرئيسية والإعدادات غير كسولة.

- **Suspense fallback**: عند تحميل الصفحة نعرض مكوّن التحميل (شعار فقط بدون شريط أو نص): `LoadingLogo`.

---

## 5. واجهة التحميل

- **شعار التحميل (بدون شريط أو نص)**  
  المكوّن: `src/components/LoadingLogo.jsx` — نفس شعار الشاشة الافتتاحية مع الهالة، بدون شريط التقدم أو النص. يُستخدم في:
  - fallback لـ Suspense في التطبيق،
  - صفحة الخطوط عند جلب الخطوط من الـ API (أول تحميل بدون كاش)،
  - صفحة الباقات عند جلب الباقات من الـ API (أول تحميل بدون كاش).

---

## 6. ملخص سريع

| الهدف              | ما تم تطبيقه / الملف أو المكان |
|--------------------|----------------------------------|
| سرعة إضافة خط      | Optimistic add ثم استبدال بالنتيجة — LinesPage |
| عدم إعادة جلب القائمة بعد الطفرات | تحديث من نتيجة الطلب فقط — LinesPage, PackagesPage |
| سرعة العودة للصفحة | كاش خطوط وباقات 1 دقيقة — apiCache.js |
| استقرار Gate      | gate مع dataRef و [auth] — DataContext |
| تحميل كسول        | React.lazy للصفحات — App.jsx |
| مؤشر تحميل موحّد  | LoadingLogo (شعار فقط) — App, Lines, Packages |

---

لجعل التطبيق أخف أكثر لاحقًا: تقليل الاعتماديات، تحسين حجم الـ bundle (تحليل مع Vite)، واستخدام قوائم افتراضية (virtual list) إذا نمت القوائم إلى آلاف العناصر.
